# 功能規格書：百家樂遊戲

**功能分支**: `001-baccarat-game`  
**建立日期**: 2025-10-25  
**狀態**: 草稿  
**輸入描述**: "百家樂（Baccarat）遊戲 - 2D桌面遊戲，客戶端邏輯，NPC自動發牌"

## 澄清事項

### Session 2025-10-25

- Q: 遊戲如何與玩家帳戶系統整合來更新餘額？ → A: 完全在本地 localStorage/sessionStorage 管理餘額，不與外部系統同步
- Q: 遊戲需要什麼程度的隨機數品質和公平性驗證？ → A: 使用標準 Math.random()，不需要特別的公平性驗證或可重現性
- Q: 玩家如何管理初始餘額？ → A: 餘額歸零時自動重置為 10,000 元，讓玩家可以繼續遊戲

## 使用者情境與測試 *(必填)*

<!--
  重要提醒：使用者故事應該按重要性排序。
  每個使用者故事/旅程必須可獨立測試 - 意即如果您只實作其中一個，
  仍應該有一個可行的最小可行產品（MVP）能提供價值。
  
  為每個故事指派優先級（P1、P2、P3等），其中P1是最關鍵的。
  將每個故事視為可以獨立進行的功能切片：
  - 獨立開發
  - 獨立測試
  - 獨立部署
  - 獨立向使用者展示
-->

### 使用者故事 1 - 基本投注與遊戲流程 (優先級：P1)

玩家進入百家樂遊戲後，可以選擇籌碼面額並在莊家、閒家或和局區域下注，然後觀看NPC自動發牌、補牌並判定勝負，最後根據結果獲得獎勵或失去投注金額。

**優先級原因**：這是百家樂遊戲的核心流程，沒有此功能遊戲無法運作。這是最小可行產品的基礎。

**獨立測試**：可透過完整執行一局遊戲（選擇籌碼 → 下注 → 發牌 → 結算）來完整測試，並驗證獎金計算是否正確。

**驗收情境**：

1. **前提** 玩家進入遊戲畫面且帳戶餘額充足，**當** 玩家選擇籌碼面額並點擊閒家區域下注100元，**則** 系統顯示該區域已下注100元且餘額減少100元
2. **前提** 玩家已完成下注，**當** 倒數計時結束或玩家確認下注，**則** NPC依序發出四張牌（閒家-莊家-閒家-莊家）並顯示發牌動畫
3. **前提** 已發出四張牌，**當** 系統根據補牌規則決定是否補第三張，**則** 符合補牌條件的一方會顯示補牌動畫
4. **前提** 所有牌已發完，**當** 系統計算最終點數，**則** 顯示莊家點數、閒家點數及勝負結果
5. **前提** 玩家下注100元於閒家且閒家獲勝，**當** 結算執行，**則** 玩家獲得100元獎金（1:1賠率），帳戶餘額增加100元
6. **前提** 玩家下注100元於莊家且莊家獲勝，**當** 結算執行，**則** 玩家獲得95元獎金（1:0.95賠率，扣除5%抽水），帳戶餘額增加95元
7. **前提** 玩家下注100元於和局且結果為和局，**當** 結算執行，**則** 玩家獲得800元獎金（1:8賠率），帳戶餘額增加800元

---

### 使用者故事 2 - 多區域同時下注 (優先級：P2)

玩家可以在同一局遊戲中同時對莊家、閒家和和局三個區域進行不同金額的下注，系統會分別計算各區域的輸贏並結算總收益。

**優先級原因**：這是進階玩法，讓玩家可以採用更多元的投注策略，提升遊戲趣味性和深度。

**獨立測試**：可透過在三個區域各下注不同金額，然後驗證每個區域的獨立結算是否正確來測試。

**驗收情境**：

1. **前提** 玩家帳戶餘額為1000元，**當** 玩家在莊家下注100元、閒家下注50元、和局下注20元，**則** 系統顯示三個區域的下注金額且餘額減少170元
2. **前提** 玩家已對三個區域下注，**當** 遊戲結果為莊家勝，**則** 莊家投注區獲得95元獎金，閒家和和局投注失去本金，總收益為-75元
3. **前提** 玩家已對三個區域下注，**當** 遊戲結果為和局，**則** 和局投注區獲得160元獎金，莊家和閒家投注退還本金，總收益為+160元

---

### 使用者故事 3 - 歷史紀錄與統計顯示 (優先級：P2)

玩家可以查看最近10局的遊戲結果歷史紀錄，包括每局的莊閒勝負、牌面點數，幫助玩家分析趨勢做出投注決策。

**優先級原因**：歷史紀錄是真實百家樂遊戲的標準功能，玩家習慣參考歷史趨勢來決定投注策略。

**獨立測試**：可透過連續進行10局以上遊戲，然後驗證歷史紀錄是否正確顯示最近10局的完整資訊。

**驗收情境**：

1. **前提** 玩家已完成一局遊戲，**當** 遊戲結算完成，**則** 歷史紀錄區域新增一筆記錄，顯示本局莊家/閒家/和局結果
2. **前提** 歷史紀錄中已有10筆記錄，**當** 新的一局結束，**則** 最舊的記錄被移除，最新記錄加入，保持總數為10筆
3. **前提** 玩家查看歷史紀錄，**當** 點擊某一筆記錄，**則** 顯示該局詳細資訊（莊家牌面、閒家牌面、各方點數）

---

### 使用者故事 4 - 遊戲動畫與視覺回饋 (優先級：P3)

遊戲提供流暢的發牌動畫、籌碼移動動畫、結果顯示動畫，讓玩家獲得沉浸式的遊戲體驗。

**優先級原因**：雖然動畫不影響遊戲邏輯，但能大幅提升使用者體驗和遊戲質感，是提升產品競爭力的重要因素。

**獨立測試**：可透過觀察遊戲流程中各個階段的動畫表現（發牌、籌碼移動、結果展示）來測試。

**驗收情境**：

1. **前提** 玩家完成下注，**當** 發牌開始，**則** 每張牌以流暢動畫從牌堆移動到莊家或閒家位置，每張牌間隔0.5秒
2. **前提** 需要補牌，**當** 補牌執行，**則** 第三張牌以相同動畫方式發出並翻開
3. **前提** 遊戲結算完成，**當** 玩家獲勝，**則** 獎金籌碼以動畫方式移動到玩家帳戶區域，並顯示金額增加的數字跳動效果
4. **前提** 遊戲結算完成，**當** 玩家失敗，**則** 下注籌碼以動畫方式被收走，並顯示金額減少效果

---

### 使用者故事 5 - 連續多局遊戲與牌靴機制 (優先級：P3)

遊戲使用包含8副撲克牌（共416張）的牌靴，支援連續多局遊戲而不重新洗牌，當牌靴中剩餘牌數低於一定數量時自動觸發洗牌。

**優先級原因**：這是真實百家樂遊戲的標準規則，提供更真實的遊戲體驗，但不影響基本遊戲功能。

**獨立測試**：可透過連續進行多局遊戲，觀察牌靴剩餘張數變化，並驗證洗牌觸發時機來測試。

**驗收情境**：

1. **前提** 遊戲開始時牌靴包含416張牌，**當** 完成第一局遊戲使用了5張牌，**則** 牌靴剩餘411張牌，下一局繼續使用相同牌靴
2. **前提** 牌靴剩餘牌數低於52張（一副牌），**當** 該局遊戲結束，**則** 系統顯示洗牌動畫並重新生成416張牌的新牌靴
3. **前提** 正在使用牌靴的第50局遊戲，**當** 發牌時，**則** 從當前牌靴位置依序發牌，確保牌的順序符合隨機但連續的邏輯

---

### 邊界情境

- **帳戶餘額不足時會發生什麼？** 當玩家嘗試下注金額超過帳戶餘額時，系統阻止下注並顯示「餘額不足」提示訊息
- **帳戶餘額歸零時會如何？** 當餘額降至 0 元或以下時，系統自動重置餘額為 10,000 元並顯示「餘額已重置」通知，讓玩家可以繼續遊戲
- **玩家在倒數計時中途修改下注會如何？** 允許玩家在倒數計時結束前隨時增加、減少或清除下注，倒數結束後鎖定不可修改
- **玩家完全不下注直接進入遊戲會如何？** 允許玩家不下注觀看遊戲進行，結算時不影響帳戶餘額，僅記錄歷史結果
- **發生牌組異常（如牌數不足）會如何？** 該局宣告無效，退還所有下注金額，系統自動重新洗牌並開始新局
- **玩家在發牌過程中關閉遊戲會如何？** 遊戲狀態儲存至 localStorage，下次開啟時自動恢復並完成該局，結果正常結算並更新餘額
- **同時達到多個勝利條件（如雙方都是8點）會如何？** 這種情況判定為和局，按和局規則結算
- **牌靴在發牌過程中耗盡會如何？** 優先完成當前這局遊戲（如果牌數足夠），若不足則該局作廢並立即重新洗牌

## 需求規格 *(必填)*

### 功能需求

**遊戲基礎功能**

- **FR-001**: 系統必須提供2D桌面視角的百家樂遊戲介面，顯示莊家、閒家和和局三個下注區域
- **FR-002**: 系統必須允許玩家選擇不同面額的籌碼（10、50、100、500、1000元）
- **FR-003**: 系統必須允許玩家在倒數計時期間對任意下注區域進行下注、增減注或取消下注
- **FR-004**: 系統必須顯示下注倒數計時器，時間到達後自動鎖定下注不可修改
- **FR-005**: 系統必須在玩家下注金額超過帳戶餘額時阻止下注並提示「餘額不足」
- **FR-006**: 系統必須在玩家帳戶餘額降至 0 元或以下時，自動重置餘額為 10,000 元並顯示通知訊息

**發牌與遊戲邏輯**

- **FR-007**: 系統必須使用包含8副撲克牌（共416張）的虛擬牌靴作為發牌來源
- **FR-008**: 系統必須按照標準百家樂規則依序發出四張牌（閒-莊-閒-莊）
- **FR-009**: 系統必須根據百家樂補牌規則自動判定是否需要為莊家或閒家補第三張牌
- **FR-010**: 系統必須正確計算牌面點數（A=1, 2-9=面值, 10/J/Q/K=0，總和取個位數）
- **FR-011**: 系統必須根據最終點數判定勝負（閒家勝/莊家勝/和局）

**補牌規則實作**

- **FR-012**: 當閒家前兩張牌點數為0-5時必須補牌，6-7不補牌，8-9為天生勝雙方不補牌
- **FR-013**: 當閒家未補牌且莊家點數0-5時必須補牌，6-7不補牌，8-9不補牌
- **FR-014**: 當閒家有補牌時，莊家必須根據自身點數和閒家第三張牌決定是否補牌：
  - 莊家0-2：一律補牌
  - 莊家3：閒家第三張非8時補牌
  - 莊家4：閒家第三張為2-7時補牌
  - 莊家5：閒家第三張為4-7時補牌
  - 莊家6：閒家第三張為6-7時補牌
  - 莊家7：不補牌
  - 莊家8-9：不補牌

**結算與賠率**

- **FR-015**: 閒家勝時，閒家投注區必須按1:1賠率發放獎金
- **FR-016**: 莊家勝時，莊家投注區必須按1:0.95賠率發放獎金（扣除5%抽水）
- **FR-017**: 和局時，和局投注區必須按1:8賠率發放獎金
- **FR-018**: 和局時，莊家和閒家投注區的下注金額必須退還給玩家（不計輸贏）
- **FR-019**: 系統必須在結算後更新玩家帳戶餘額並顯示本局輸贏金額

**使用者介面**

- **FR-020**: 系統必須從 localStorage 讀取並顯示玩家當前帳戶餘額
- **FR-021**: 系統必須顯示每個下注區域的當前下注金額總和
- **FR-022**: 系統必須在發牌時以動畫方式逐張顯示牌面
- **FR-023**: 系統必須在遊戲結束時明確顯示莊家點數、閒家點數和勝負結果
- **FR-024**: 系統必須顯示最近10局的歷史紀錄，包含每局的勝負結果
- **FR-025**: 系統必須提供「開始新局」按鈕讓玩家進入下一輪遊戲

**資料持久性**

- **FR-026**: 系統必須使用瀏覽器 localStorage 儲存玩家帳戶餘額
- **FR-027**: 系統必須在每次結算後立即將更新後的餘額寫入 localStorage
- **FR-028**: 系統必須在遊戲初始化時從 localStorage 讀取餘額，若無資料則設定預設初始餘額為 10,000 元
- **FR-029**: 系統必須使用 localStorage 儲存最近10局的歷史紀錄

**牌靴與洗牌機制**

- **FR-030**: 系統必須在遊戲初始化時建立包含416張牌的虛擬牌靴並使用 Math.random() 執行隨機洗牌
- **FR-031**: 系統必須在連續多局遊戲中使用同一個牌靴，依序從牌靴中發牌
- **FR-032**: 系統必須在牌靴剩餘牌數低於52張時自動觸發重新洗牌
- **FR-033**: 系統必須在每次洗牌時重置牌靴為416張牌並使用 Math.random() 重新隨機排序

**錯誤處理**

- **FR-034**: 當發生牌組異常（如牌數不足無法完成發牌）時，系統必須宣告該局無效並退還所有下注金額
- **FR-035**: 當玩家在遊戲進行中關閉應用程式時，系統必須將當前遊戲狀態儲存至 localStorage，下次開啟時自動完成該局並更新餘額

### 關鍵實體

- **玩家帳戶**：包含玩家ID、當前餘額、歷史遊戲記錄，負責追蹤玩家的資金狀態
- **遊戲局（Game Round）**：代表單次完整的百家樂遊戲，包含下注資訊、發出的牌面、最終結果、時間戳記
- **牌靴（Shoe）**：包含8副撲克牌的虛擬牌組，記錄當前已發出的牌數和剩餘牌的順序
- **下注紀錄**：記錄玩家在特定遊戲局中對莊家、閒家、和局的下注金額
- **牌面（Card）**：代表單張撲克牌，包含花色和點數資訊
- **結果歷史**：記錄最近10局的遊戲結果（莊勝/閒勝/和局）以供玩家參考

## 成功標準 *(必填)*

### 可衡量成果

**使用者體驗指標**

- **SC-001**: 玩家能在30秒內完成一局完整遊戲（從下注到結算顯示）
- **SC-002**: 90%的玩家在首次遊玩時能在無教學提示下成功完成下注和遊戲流程
- **SC-003**: 發牌動畫流暢度維持在60 FPS，提供沉浸式視覺體驗
- **SC-004**: 玩家點擊下注按鈕後，系統在100毫秒內提供視覺回饋（籌碼顯示或錯誤提示）

**遊戲邏輯正確性**

- **SC-005**: 100%的遊戲局數中，補牌邏輯符合標準百家樂規則，無任何錯誤判定
- **SC-006**: 100%的結算金額計算正確，賠率誤差為0
- **SC-007**: 連續進行1000局遊戲，牌靴洗牌和發牌邏輯無異常，無重複牌或缺牌情況
- **SC-008**: 所有邊界情境（餘額不足、牌組異常、中途退出）都能正確處理並提供明確回饋

**效能與穩定性**

- **SC-009**: 系統能支援玩家連續進行100局遊戲而不發生記憶體洩漏或效能下降
- **SC-010**: 遊戲初始載入時間少於2秒（包含資源載入和首次渲染）
- **SC-011**: 歷史紀錄查詢回應時間少於50毫秒

**商業指標**

- **SC-012**: 玩家平均遊戲時長達到15分鐘以上，顯示遊戲吸引力足夠
- **SC-013**: 玩家返回率（7天內再次遊玩）達到40%以上
- **SC-014**: 遊戲錯誤率（因系統錯誤導致的無效局數）低於0.1%

## 假設條件

- 玩家在進入遊戲時已完成身份驗證和帳戶設定
- 玩家帳戶餘額使用瀏覽器 localStorage 儲存和管理，遊戲為獨立運作的客戶端應用程式
- 遊戲為純客戶端實作，不需要與伺服器即時同步狀態
- 隨機數生成使用標準 Math.random() 演算法，為娛樂性質遊戲，不需要加密級隨機數或公平性驗證機制
- 遊戲狀態（包含中途遊戲）儲存至 localStorage，關閉應用程式後下次開啟時自動恢復
- 所有視覺資源（撲克牌圖片、籌碼圖片、桌面背景）已準備完成
- 遊戲介面支援解析度至少為1024x768像素的桌面環境
- 不需要支援多人遊戲或真人荷官功能
- 歷史紀錄僅保留最近10局，更早的記錄自動刪除
- 倒數計時預設為15秒，可在遊戲設定中調整

## 範圍界定

**包含在此功能內：**

- 完整的單人百家樂遊戲邏輯（下注、發牌、補牌、結算）
- 2D桌面視角的遊戲介面
- 籌碼選擇和下注操作
- 自動NPC發牌和判定
- 賠率計算和餘額更新
- 發牌動畫和結果顯示
- 最近10局歷史紀錄
- 8副牌靴機制和自動洗牌
- 錯誤處理和邊界情境處理

**不包含在此功能內：**

- 多人遊戲或玩家對戰功能
- 真人荷官視訊串流
- 網路連線或伺服器同步
- 聊天室或社交功能
- 玩家帳戶管理系統（註冊、登入、儲值）
- 排行榜或成就系統
- 音效和背景音樂（視後續需求決定）
- 行動裝置（手機/平板）適配（本版本僅支援桌面）
- 遊戲回放功能
- 進階統計分析（如連勝次數、投注趨勢圖表）

**未來可能擴充：**

- 側注玩法（對子、大小、幸運六等）
- 詳細統計報表（勝率、投注分析、路單顯示）
- 自動投注功能（根據策略自動下注）
- 音效和背景音樂
- 多語言支援
- 行動裝置版本
